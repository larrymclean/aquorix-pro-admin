/*
  File: useDashboardSchedule.ts
  Path: /Users/larrymclean/CascadeProjects/aquorix-frontend/src/hooks/useDashboardSchedule.ts
  Description:
    Phase 5A/5B hook for schedule fetch with deterministic refresh behavior.

    Key fix:
    - When refreshing, DO NOT drop the last good data.
    - Expose isRefreshing so UI can keep rendering (no button flash).

  Author: AQUORIX Team
  Created: 2026-02-14
  Version: 1.1.0

  Change Log:
    - 2026-02-14 - v1.0.0:
      - Initial creation (loading/error/ready)
    - 2026-02-16 - v1.1.0:
      - Preserve last good data during refresh (no UI flash)
      - Add refresh() + isRefreshing flag
*/

import { useCallback, useEffect, useRef, useState } from "react";
import { getDashboardSchedule } from "../api/dashboardSchedule";
import type { DashboardScheduleResponse } from "../types/dashboardSchedule";

type State =
  | { status: "loading"; data?: undefined; error?: undefined; isRefreshing: false }
  | { status: "error"; data?: DashboardScheduleResponse; error: any; isRefreshing: false }
  | { status: "ready"; data: DashboardScheduleResponse; error?: undefined; isRefreshing: boolean };

export function useDashboardSchedule(weekStart?: string) {
  const [state, setState] = useState<State>({
    status: "loading",
    isRefreshing: false
  });

  // Keeps the last known good data so refresh doesn't "blank" the UI.
  const lastGoodDataRef = useRef<DashboardScheduleResponse | null>(null);

  const load = useCallback(
    async (mode: "initial" | "refresh") => {
      // Initial load: show loading screen
      if (mode === "initial") {
        setState({ status: "loading", isRefreshing: false });
      }

      // Refresh: keep the UI, just mark refreshing
      if (mode === "refresh") {
        const existing = lastGoodDataRef.current;
        if (existing) {
          setState({ status: "ready", data: existing, isRefreshing: true });
        } else {
          // No data yet, behave like initial
          setState({ status: "loading", isRefreshing: false });
        }
      }

      try {
        const data = await getDashboardSchedule(weekStart);
        lastGoodDataRef.current = data;
        setState({ status: "ready", data, isRefreshing: false });
      } catch (error) {
        const existing = lastGoodDataRef.current;

        // If we have old data, keep it visible and surface error as "error state"
        // (you can decide later if you want a softer banner).
        if (existing) {
          setState({ status: "error", data: existing, error, isRefreshing: false });
        } else {
          setState({ status: "error", error, isRefreshing: false });
        }
      }
    },
    [weekStart]
  );

  useEffect(() => {
    let cancelled = false;

    (async () => {
      if (cancelled) return;
      await load("initial");
    })();

    return () => {
      cancelled = true;
    };
  }, [load]);

  const refresh = useCallback(() => {
    load("refresh");
  }, [load]);

  return { state, refresh };
}
